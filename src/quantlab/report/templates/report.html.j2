<!DOCTYPE html>
<html>
<head>
    <title>QuantLab Strategy Report - {{ run_id }}</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { text-align: center; border-bottom: 2px solid #ccc; padding-bottom: 20px; }
        .section { margin: 30px 0; }
        .subsection { margin: 20px 0; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .metric-card { border: 1px solid #ddd; padding: 15px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .metric-name { font-size: 14px; color: #7f8c8d; }
        .plot-container { margin: 20px 0; text-align: center; }
        .plot-image { max-width: 100%; height: auto; }
        .table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .table th { background-color: #f2f2f2; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>QuantLab Strategy Report</h1>
        <p><strong>Run ID:</strong> {{ run_id }}</p>
        <p><strong>Generated:</strong> {{ generated_at }}</p>
        <p><strong>Strategy:</strong> {{ spec.strategy_name }}</p>
    </div>

    {% if summary %}
    <div class="section">
        <h2>Executive Summary</h2>
        <div class="summary-grid">
            {% for metric, value in summary.key_metrics.items() %}
            <div class="metric-card">
                <div class="metric-value">{{ "%.4g"|format(value) if value is number else value }}</div>
                <div class="metric-name">{{ metric.replace('_', ' ').title() }}</div>
            </div>
            {% endfor %}
        </div>
        {% if summary.risk_warnings %}
        <div class="warning">
            <h3>Risk Warnings</h3>
            <ul>
            {% for warning in summary.risk_warnings %}
            <li>{{ warning }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="section">
        <h2>Performance Analysis</h2>
        {% if plots.equity_curve %}
        <div class="plot-container">
            <h3>Equity Curve</h3>
            <img src="{{ plots.equity_curve }}" alt="Equity Curve" class="plot-image">
        </div>
        {% endif %}

        {% if plots.drawdown %}
        <div class="plot-container">
            <h3>Drawdown Analysis</h3>
            <img src="{{ plots.drawdown }}" alt="Drawdown" class="plot-image">
        </div>
        {% endif %}

        {% if backtest_results.metrics %}
        <h3>Metrics Table</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for metric, value in backtest_results.metrics.items() %}
                <tr>
                    <td>{{ metric.replace('_', ' ').title() }}</td>
                    <td>{{ "%.4g"|format(value) if value is number else value }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    {% if optimization_results %}
    <div class="section">
        <h2>Optimization Results</h2>
        {% if plots.sensitivity_heatmap %}
        <div class="plot-container">
            <h3>Sensitivity Analysis</h3>
            <img src="{{ plots.sensitivity_heatmap }}" alt="Sensitivity Heatmap" class="plot-image">
        </div>
        {% endif %}

        {% if optimization_results.best_params %}
        <h3>Best Parameters</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for param, value in optimization_results.best_params.items() %}
                <tr>
                    <td>{{ param.replace('_', ' ').title() }}</td>
                    <td>{{ "%.4g"|format(value) if value is number else value }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endif %}

    {% if robustness_results %}
    <div class="section">
        <h2>Robustness Analysis</h2>
        {% if robustness_results.summary %}
        <h3>Robustness Summary</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {% for metric, value in robustness_results.summary.items() %}
                {% if value is mapping %}
                    {% for sub_metric, sub_value in value.items() %}
                    <tr>
                        <td>{{ metric.replace('_', ' ')|title }} - {{ sub_metric.replace('_', ' ')|title }}</td>
                        <td>{{ "%.4g"|format(sub_value) if sub_value is number else sub_value }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td>{{ metric.replace('_', ' ')|title }}</td>
                        <td>{{ "%.4g"|format(value) if value is number else value }}</td>
                    </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endif %}

    {% if leakage_results and leakage_results.summary %}
    <div class="section">
        <h2>Leakage Detection</h2>
        {% if leakage_results.summary.passed %}
        <div style="color: green;">âœ“ No significant leakage detected</div>
        {% else %}
        <div class="error">
            <h3>Issues Detected</h3>
            <ul>
            {% for issue in leakage_results.summary.issues %}
            <li><strong>{{ issue.check }}:</strong> {{ issue.details }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="section">
        <h2>Configuration</h2>
        <pre>{{ spec | tojson(indent=2) }}</pre>
    </div>
</body>
</html>